<?phpclass CommunityshowAction extends CommonAction{    private $create_fields = array('community_name',  'user_id', 'city_id', 'area_id','business_id','total_price','third_profit' );    private $edit_fields = array('community_name',   'user_id', 'city_id', 'area_id','business_id','total_price','third_profit');    public function index()    {        $Community = D('Communityshow');        import('ORG.Util.Page');        // 导入分页类        $map = array();        $users = $this->_param('data', false);        if ($users['user_id']) {            $map['user_id'] = $users['user_id'];        }        $keyword = $this->_param('keyword', 'htmlspecialchars');        if ($keyword) {            $map['community_name'] = array('LIKE', '%' . $keyword . '%');        }        $count = $Community->where($map)->count();        // 查询满足要求的总记录数        $Page = new Page($count, 25);        // 实例化分页类 传入总记录数和每页显示的记录数        $show = $Page->show();        // 分页显示输出        $list = $Community->where($map)->order(array('show_id' => 'desc'))->limit($Page->firstRow . ',' . $Page->listRows)->select();        $user_ids = array();        foreach ($list as $k => $val) {            $list[$k] = $Community->_format($val);            $user_ids[$val['user_id']] = $val['user_id'];        }        if (!empty($user_ids)) {            $this->assign('users', D('Users')->itemsByIds($user_ids));        }        $this->assign('keyword', $keyword);        $this->assign('list', $list);        // 赋值数据集www.hatudou.com  二开开发qq  120585022        $this->assign('page', $show);        // 赋值分页输出        $this->display();        // 输出模板    }		    public function create()    {        if ($this->isPost()) {            $data = $this->createCheck();            $obj = D('Communityshow');            if ($obj->add($data)) {                $obj->cleanCache();                $this->baoSuccess('添加成功', U('communityshow/index'));            }            $this->baoError('操作失败！');        } else {			$admins = D('Admin')->where(array('role_id' => 11, 'closed' => 0))->select();			//print_r($admins);            $this->assign('areas', D('Area')->fetchAll());            $this->assign('admins',$admins);            $this->display();        }    }    private function createCheck()    {        $data = $this->checkFields($this->_post('data', false), $this->create_fields);        $data['community_name'] = htmlspecialchars($data['community_name']);        if (empty($data['community_name'])) {            $this->baoError('小区名称不能为空');        }        $data['city_id'] = (int) $data['city_id'];        $data['area_id'] = (int) $data['area_id'];        $data['business_id'] = (int) $data['business_id'];        if (empty($data['business_id'])) {            $this->baoError('所在商圈不能为空');        }        $data['total_price'] = (int) ($data['total_price']*100);        if (empty($data['total_price'])) {            $this->baoError('活动总收款不能为空');        }        $data['third_profit'] = (int) ($data['third_profit']*100);        if (empty($data['third_profit'])) {            $this->baoError('物业分成不能为空');        }        $data['create_time'] = NOW_TIME;        return $data;    }    public function edit($show_id = 0)    {        if ($show_id = (int) $show_id) {            $obj = D('Communityshow');            if (!($detail = $obj->find($show_id))) {                $this->baoError('请选择要编辑的社区展示');            }            if ($this->isPost()) {                $data = $this->editCheck();                $data['show_id'] = $show_id;                if (false !== $obj->save($data)) {                    $obj->cleanCache();                    $this->baoSuccess('操作成功', U('communityshow/index'));                }                $this->baoError('操作失败');            } else {				$admins = D('Admin')->where(array('role_id' => 11, 'closed' => 0))->select();				//print_r($admins);                $this->assign('detail', $detail);                $this->assign('users', D('Users')->find($detail['user_id']));                $this->assign('villages', D('village')->find($detail['village_id']));                $this->assign('areas', D('Area')->fetchAll());				$this->assign('admins',$admins);                $this->display();            }        } else {            $this->baoError('请选择要编辑的商圈管理');        }    }    private function editCheck()    {        $data = $this->checkFields($this->_post('data', false), $this->edit_fields);        $data['community_name'] = htmlspecialchars($data['community_name']);        if (empty($data['community_name'])) {            $this->baoError('小区名称不能为空');        }        $data['city_id'] = (int) $data['city_id'];        $data['area_id'] = (int) $data['area_id'];        $data['business_id'] = (int) $data['business_id'];        if (empty($data['business_id'])) {            $this->baoError('所在商圈不能为空');        }        $data['total_price'] = (int) ($data['total_price']*100);        if (empty($data['total_price'])) {            $this->baoError('活动总收款不能为空');        }        $data['third_profit'] = (int) ($data['third_profit']*100);        if (empty($data['third_profit'])) {            $this->baoError('物业分成不能为空');        }        return $data;    }    public function delete($show_id = 0)    {        if (is_numeric($show_id) && ($show_id = (int) $show_id)) {            $obj = D('Communityshow');            $obj->delete($show_id);            $obj->cleanCache();            $this->baoSuccess('删除成功！', U('communityshow/index'));        } else {            $show_id = $this->_post('show_id', false);            if (is_array($show_id)) {                $obj = D('Communityshow');                foreach ($show_id as $id) {                    $obj->delete($id);                }                $obj->cleanCache();                $this->baoSuccess('删除成功！', U('communityshow/index'));            }            $this->baoError('请选择要删除的社区展示');        }    }    public function divide($show_id = 0)    {        $show_id = (int) $show_id;        $communityshow=D('Communityshow')->find($show_id);        //物业分成信息        $community=D('Community')->where(array('business_id'=>$communityshow['business_id']))->find();        //项目经理分成比例        $community_manager=D('Communitymanager')->where(array('community_id'=>$community['community_id']))->find();        //第三方分成-物业分成        //项目经理分成比例        $ratio=$community_manager['third_profit']/10000;        //项目经理分成        $manager_profit=$communityshow['third_profit']/100*$ratio;        $flag1=D('Users')->addMoney($community_manager['user_id'],$manager_profit*100, '小区项目经理分成：现场活动ID' . $show_id);        //小区物业分成        $community_profit=$communityshow['third_profit']/100-$manager_profit;        $flag2=D('Admin')->Thirdgold($community_manager['wuye_id'], $community_manager['community_id'], $community_profit*100, '小区物业分成：现场活动ID' .$show_id,'other',$show_id);        if($flag1&&$flag2){            $this->baoSuccess('分成成功！', U('communityshow/index'));        }else{            $this->baoError('分成失败，请重新分成！', U('communityshow/index'));        }    }}